{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Nuevo Cliente" %}{% endblock %}

{% block content %}
<main class="w-full max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- HEADER -->
  <section class="mb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-3">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">{% trans "Nuevo Cliente" %}</h1>
      <p class="text-sm text-gray-600 dark:text-gray-300">{% trans "Captura de datos con validación ligera." %}</p>
    </div>
    <div class="flex gap-2">
      <a href="{% url 'backoffice:listar_clientes' %}"
         class="inline-flex items-center gap-2 rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-800 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700">
        <i class="fa-solid fa-arrow-left"></i> {% trans "Volver" %}
      </a>
      <button form="form-cliente"
              class="inline-flex items-center gap-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 text-sm font-semibold">
        <i class="fa-solid fa-save"></i> {% trans "Guardar" %}
      </button>
    </div>
  </section>

  <!-- FORM -->
  <form id="form-cliente" method="post" novalidate
        class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 shadow-sm p-6 space-y-8">
    {% csrf_token %}

    <!-- Identidad -->
    <section>
      <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3">{% trans "Identidad" %}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Nombre" %} *</label>
          <input id="nombre" name="nombre" required autocomplete="given-name"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="apellidos" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Apellidos" %} *</label>
          <input id="apellidos" name="apellidos" required autocomplete="family-name"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div class="flex items-center gap-3 mt-6">
          <input id="es_vip" name="es_vip" type="checkbox"
                 class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-400">
          <label for="es_vip" class="text-sm text-gray-700 dark:text-gray-300">{% trans "Cliente VIP" %}</label>
        </div>
      </div>
      <p id="vip-warn" class="hidden mt-2 text-xs text-amber-700 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded px-3 py-2">
        {% trans "Si marcas VIP, completa al menos una identificación (Carnet, Pasaporte o Licencia)." %}
      </p>
    </section>

    <!-- Contacto -->
    <section>
      <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3">{% trans "Contacto" %}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
          <input id="email" type="email" name="email" autocomplete="email" placeholder="cliente@dominio.com"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="telefono_principal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Teléfono principal" %}</label>
          <input id="telefono_principal" name="telefono_principal" autocomplete="tel" placeholder="+53 5 123 4567"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
      </div>
    </section>

    <!-- Dirección -->
    <section>
      <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3">{% trans "Dirección" %}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label for="direccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Dirección" %}</label>
          <input id="direccion" name="direccion" autocomplete="address-line1" placeholder="Calle 10 No. 50"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="ciudad" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Ciudad" %}</label>
          <input id="ciudad" name="ciudad" autocomplete="address-level2" placeholder="Miami"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="estado" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Estado" %}</label>
          <input id="estado" name="estado" autocomplete="address-level1" placeholder="Florida"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="pais" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "País" %}</label>
          <input id="pais" name="pais" autocomplete="country-name" placeholder="USA"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="zip_code" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ZIP</label>
          <input id="zip_code" name="zip_code" autocomplete="postal-code" placeholder="33174"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
      </div>
    </section>

    <!-- Identificaciones -->
    <section>
      <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3">{% trans "Identificaciones" %}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="carnet_identidad" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Carnet de Identidad" %}</label>
          <input id="carnet_identidad" name="carnet_identidad"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="pasaporte" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Pasaporte" %}</label>
          <input id="pasaporte" name="pasaporte"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="licencia" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Licencia" %}</label>
          <input id="licencia" name="licencia"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div class="md:col-span-3">
          <label for="pasaporte_licencia" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Otra identificación / Notas" %}</label>
          <input id="pasaporte_licencia" name="pasaporte_licencia"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
      </div>
    </section>

    <!-- Otros -->
    <section>
      <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3">{% trans "Otros" %}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="fecha_nacimiento" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Fecha de Nacimiento" %}</label>
          <input id="fecha_nacimiento" type="date" name="fecha_nacimiento"
                 class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"/>
        </div>
        <div>
          <label for="observaciones" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Observaciones" %}</label>
          <textarea id="observaciones" name="observaciones" rows="3" placeholder="{% trans 'Notas importantes…' %}"
                    class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"></textarea>
        </div>
      </div>
    </section>

    <!-- Acciones -->
    <div class="flex gap-2">
      <a href="{% url 'backoffice:listar_clientes' %}"
         class="inline-flex items-center gap-2 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-100 px-5 py-2 text-sm font-semibold">
        <i class="fas fa-times-circle"></i> {% trans "Cancelar" %}
      </a>
      <button class="inline-flex items-center gap-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 text-sm font-semibold">
        <i class="fas fa-check"></i> {% trans "Guardar" %}
      </button>
    </div>
  </form>

  <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
    {% trans "Atajo: Ctrl/Cmd + Enter para enviar." %}
  </p>
</main>

<!-- JS: Validación VIP + UX -->
<script>
  (function () {
    const form = document.getElementById('form-cliente');
    const esVip = document.getElementById('es_vip');
    const vipWarn = document.getElementById('vip-warn');
    const reqs = ['nombre','apellidos'].map(id => document.getElementById(id));
    const idDocs = ['carnet_identidad','pasaporte','licencia'].map(id => document.getElementById(id));
    let submitting = false;

    function vipNeedsId() {
      if (!esVip.checked) return true;
      return idDocs.some(i => i && i.value.trim().length > 0);
    }

    function showVipWarn(show) {
      vipWarn.classList.toggle('hidden', !show);
    }

    esVip.addEventListener('change', () => {
      showVipWarn(esVip.checked && !vipNeedsId());
    });

    form.addEventListener('submit', (e) => {
      // HTML5 required primero
      if (!form.checkValidity()) {
        e.preventDefault();
        return;
      }
      // Regla VIP
      if (!vipNeedsId()) {
        e.preventDefault();
        showVipWarn(true);
        idDocs[0]?.focus();
        return;
      }
      // Anti doble submit
      if (submitting) { e.preventDefault(); return; }
      submitting = true;
      setTimeout(() => { submitting = false; }, 3000);
    });

    // Atajo Ctrl/Cmd + Enter
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') form.requestSubmit();
    });
  })();
</script>
{% endblock %}
