{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Editar Reserva" %} ({{ reserva.id }}){% endblock %}

{% block content %}
<main class="max-w-[1800px] mx-auto px-6 sm:px-8 py-8">

  <!-- CABECERA -->
  <section class="mb-6 flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
    <div class="border-l-4 border-indigo-600 pl-4">
      <h1 class="text-2xl font-bold text-indigo-700">üßæ {% trans "Editar Reserva" %} #{{ reserva.id }}</h1>
      <p class="text-sm text-gray-500">{% trans "Informaci√≥n b√°sica de la reserva" %}</p>
    </div>

    <div class="flex flex-wrap gap-2">

      {# DISTAL: Confirmar y ver XML #}
      {% if reserva.tipo == 'hoteles' and reserva.proveedor and reserva.proveedor.nombre == 'DISTALCU' and not reserva.numero_confirmacion %}
        <a href="{% url 'backoffice:enviar_booking_distal' reserva.id %}"
           class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
          <i class="fas fa-paper-plane mr-2"></i>{% trans "Confirmar Distal" %}
        </a>
        <a href="{% url 'backoffice:vista_preview_booking_distal' reserva.id %}"
           class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm">
          <i class="fas fa-eye mr-2"></i>{% trans "Ver XML Distal" %}
        </a>
      {% endif %}

      {# No DISTAL: Solicitar Hotel -> POST v√≠a fetch (sin anidar form) #}
      {% if reserva.tipo == 'hoteles' and (not reserva.proveedor or reserva.proveedor.nombre != 'DISTALCU') and not reserva.numero_confirmacion %}
        <button type="button" id="btn-solicitar-hotel"
                class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm"
                data-url="{% url 'common:enviar_solicitud_hotel' reserva.id %}">
          <i class="fas fa-paper-plane mr-2"></i>{% trans "Solicitar Hotel" %}
        </button>
      {% endif %}

      <a href="{% url 'backoffice:vista_preview_voucher_distal' reserva.id %}" target="_blank"
         class="inline-flex items-center px-4 py-2 bg-indigo-700 hover:bg-indigo-800 text-white rounded-lg text-sm">
        <i class="fas fa-file-pdf mr-2"></i>{% trans "Voucher PDF" %}
      </a>
    </div>
  </section>

  <!-- FORM PRINCIPAL -->
  <form id="form-reserva" action="{% url 'backoffice:guardar_edicion_reserva' reserva.id %}" method="post" novalidate>
    {% csrf_token %}

    <!-- DATOS GENERALES -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-6 bg-white p-6 rounded-2xl shadow border border-gray-200 mb-10">
      <div class="md:col-span-4">
        <h2 class="text-xl font-bold text-gray-900">{% trans "Datos Generales" %}</h2>
      </div>

      <div class="relative">
        <label class="text-sm font-medium text-gray-700">{% trans "Nombre de Usuario" %}</label>
        <i class="fas fa-user absolute left-3 top-9 text-gray-400"></i>
        <input type="text" name="nombre_usuario" value="{{ reserva.nombre_usuario }}"
               class="w-full border rounded-lg pl-10 pr-3 py-2" placeholder="{% trans 'Usuario' %}">
      </div>

      <div class="relative">
        <label class="text-sm font-medium text-gray-700">Email</label>
        <i class="fas fa-envelope absolute left-3 top-9 text-gray-400"></i>
        <input type="email" name="email_empleado" value="{{ reserva.email_empleado }}"
               class="w-full border rounded-lg pl-10 pr-3 py-2" placeholder="{% trans 'Email' %}">
      </div>

      <div>
        <label class="text-sm font-medium text-gray-700">{% trans "Tipo" %}</label>
        <input type="text" readonly value="{{ reserva.tipo }}"
               class="w-full bg-gray-100 border rounded-lg px-3 py-2">
      </div>

      <div class="flex flex-col items-center justify-center">
        <label class="text-sm font-medium text-gray-700">{% trans "Estatus actual" %}</label>
        <span class="inline-flex items-center mt-1 px-3 py-1 rounded-full text-white text-sm
          {% if reserva.estatus == 'solicitada' %}bg-blue-600
          {% elif reserva.estatus == 'pendiente' %}bg-amber-500
          {% elif reserva.estatus == 'confirmada' %}bg-green-600
          {% elif reserva.estatus == 'modificada' %}bg-indigo-600
          {% elif reserva.estatus == 'ejecutada' %}bg-purple-600
          {% elif reserva.estatus == 'cancelada' %}bg-rose-600
          {% elif reserva.estatus == 'reembolsada' %}bg-slate-700
          {% else %}bg-gray-500{% endif %}">
          <i class="mr-1
            {% if reserva.estatus == 'solicitada' %}fas fa-hourglass-half
            {% elif reserva.estatus == 'pendiente' %}fas fa-clock
            {% elif reserva.estatus == 'confirmada' %}fas fa-check
            {% elif reserva.estatus == 'modificada' %}fas fa-edit
            {% elif reserva.estatus == 'ejecutada' %}fas fa-play
            {% elif reserva.estatus == 'cancelada' %}fas fa-times
            {% elif reserva.estatus == 'reembolsada' %}fas fa-rotate-left
            {% else %}fas fa-question{% endif %}"></i>
          {{ reserva.estatus|capfirst }}
        </span>
      </div>

      <div>
        <label class="text-sm font-medium text-gray-700">{% trans "Cambiar estatus" %}</label>
        <select name="estatus" class="w-full border rounded-lg px-3 py-2">
          {% for value,label in estatus_choices %}
            <option value="{{ value }}" {% if reserva.estatus == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="text-sm font-medium text-gray-700">{% trans "Proveedor" %}</label>
        <select name="proveedor" class="w-full border rounded-lg px-3 py-2">
          <option value="">{% trans "Seleccione un proveedor" %}</option>
          {% for p in proveedores %}
            <option value="{{ p.id }}" {% if reserva.proveedor and reserva.proveedor.id == p.id %}selected{% endif %}>
              {{ p.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="relative">
        <label class="text-sm font-medium text-gray-700">{% trans "No. Confirmaci√≥n" %}</label>
        <i class="fas fa-check-double absolute left-3 top-9 text-gray-400"></i>
        <input type="text" name="numero_confirmacion" value="{{ reserva.numero_confirmacion }}"
               class="w-full border rounded-lg pl-10 pr-3 py-2" placeholder="N¬∞ Confirmaci√≥n">
      </div>

      <div>
        <label class="text-sm font-medium text-gray-700">{% trans "Costo Proveedor" %}</label>
        <input type="number" step="0.01" name="costo_sin_fee" value="{{ reserva.costo_sin_fee }}"
               class="w-full border rounded-lg px-3 py-2">
      </div>

      <div>
        <label class="text-sm font-medium text-gray-700">{% trans "Costo Agencia" %}</label>
        <input type="number" step="0.01" name="costo_total" value="{{ reserva.costo_total }}"
               class="w-full border rounded-lg px-3 py-2">
      </div>

      <div>
        <label class="text-sm font-medium text-gray-700">{% trans "Precio Agencia" %}</label>
        <input type="number" step="0.01" name="precio_total" value="{{ reserva.precio_total }}"
               class="w-full border rounded-lg px-3 py-2">
      </div>

      <div class="md:col-span-4 flex flex-wrap gap-6 items-center">
        <label class="inline-flex items-center">
          <input type="checkbox" name="cobrada" class="h-5 w-5 text-green-600"
                 {% if reserva.cobrada %}checked{% endif %}>
          <span class="ml-2 text-gray-700">{% trans "Cobrada" %}</span>
        </label>
        <label class="inline-flex items-center">
          <input type="checkbox" name="pagada" class="h-5 w-5 text-blue-600"
                 {% if reserva.pagada %}checked{% endif %}>
          <span class="ml-2 text-gray-700">{% trans "Pagada" %}</span>
        </label>
      </div>

      <div class="md:col-span-4">
        <label class="text-sm font-medium text-gray-700">{% trans "Notas" %}</label>
        <textarea name="notas" rows="3" class="w-full border rounded-lg px-3 py-2"
                  placeholder="{% trans 'Notas adicionales...' %}">{{ reserva.notas }}</textarea>
      </div>
    </section>

    <!-- HABITACIONES -->
    <section>
      <div class="mb-4">
        <h2 class="text-xl font-bold text-gray-900">üõèÔ∏è {% trans "Habitaciones" %}</h2>
        <p class="text-sm text-gray-500">{% trans "Cada habitaci√≥n puede tener m√∫ltiples pasajeros y fechas." %}</p>
      </div>

      <div id="habitaciones-container" class="space-y-8">
        {% for habitacion in habitaciones %}
          <div class="bg-white p-6 rounded-2xl shadow border border-gray-200 habitacion-card" data-index="{{ forloop.counter }}">
            <div class="flex justify-between items-center mb-5">
              <h3 class="text-lg font-bold text-indigo-700">{% trans "Habitaci√≥n" %} {{ forloop.counter }}</h3>
              <button type="button" class="bg-rose-100 text-rose-700 hover:bg-rose-200 px-4 py-2 rounded-full eliminar-habitacion">
                <i class="fas fa-trash mr-1"></i>{% trans "Eliminar" %}
              </button>
            </div>

            <input type="hidden" name="habitacion_id_{{ forloop.counter }}" value="{{ habitacion.id }}">

            <div class="grid grid-cols-12 gap-4 mb-4">
              <div class="col-span-3">
                <label class="text-sm text-gray-700">{% trans "Nombre" %}</label>
                <input type="text" name="habitacion_nombre_{{ forloop.counter }}" value="{{ habitacion.habitacion_nombre }}" class="w-full border rounded-lg px-3 py-2">
              </div>

              <div class="col-span-3">
                <label class="text-sm text-gray-700">{% trans "Fechas" %}</label>
                <input type="text" name="fechas_viaje_{{ forloop.counter }}" value="{{ habitacion.fechas_viaje }}" class="w-full border rounded-lg px-3 py-2 rango-fechas">
              </div>

              <div class="col-span-2">
                <label class="text-sm text-gray-700">{% trans "Precio" %}</label>
                <input type="number" step="0.01" name="precio_{{ forloop.counter }}" value="{{ habitacion.precio }}" class="w-full border rounded-lg px-3 py-2">
              </div>

              <div class="col-span-2">
                <label class="text-sm text-gray-700">{% trans "Adultos" %}</label>
                <input type="number" name="adultos_{{ forloop.counter }}" value="{{ habitacion.adultos }}" class="w-full border rounded-lg px-3 py-2">
              </div>

              <div class="col-span-2">
                <label class="text-sm text-gray-700">{% trans "Ni√±os" %}</label>
                <input type="number" name="ninos_{{ forloop.counter }}" value="{{ habitacion.ninos }}" class="w-full border rounded-lg px-3 py-2">
              </div>
            </div>

            <!-- Pasajeros -->
            <div id="pasajeros_habitacion_{{ habitacion.id }}" class="space-y-3">
              {% for pasajero in habitacion.pasajeros.all %}
                <div class="grid grid-cols-7 gap-2 items-end pasajero-item">

                  <input type="hidden" name="pasajero_id_{{ habitacion.id }}_{{ pasajero.id }}" value="{{ pasajero.id }}">

                  <div class="relative">
                    <i class="fas fa-user absolute left-2 top-3 text-gray-400"></i>
                    <input type="text" name="pasajero_nombre_{{ habitacion.id }}_{{ pasajero.id }}" value="{{ pasajero.nombre }}"
                           class="pl-8 border rounded-lg px-2 py-2 text-sm w-full" placeholder="{% trans 'Nombre' %}">
                  </div>

                  <div class="relative">
                    <i class="fas fa-calendar-day absolute left-2 top-3 text-gray-400"></i>
                    <input type="date" name="pasajero_fecha_nacimiento_{{ habitacion.id }}_{{ pasajero.id }}" value="{{ pasajero.fecha_nacimiento|date:'Y-m-d' }}"
                           class="pl-8 border rounded-lg px-2 py-2 text-sm w-full">
                  </div>

                  <div class="relative">
                    <i class="fas fa-passport absolute left-2 top-3 text-gray-400"></i>
                    <input type="text" name="pasajero_pasaporte_{{ habitacion.id }}_{{ pasajero.id }}" value="{{ pasajero.pasaporte }}"
                           class="pl-8 border rounded-lg px-2 py-2 text-sm w-full" placeholder="Pasaporte">
                  </div>

                  <div class="relative">
                    <i class="fas fa-calendar-check absolute left-2 top-3 text-gray-400"></i>
                    <input type="date" name="pasajero_caducidad_pasaporte_{{ habitacion.id }}_{{ pasajero.id }}" value="{{ pasajero.caducidad_pasaporte|date:'Y-m-d' }}"
                           class="pl-8 border rounded-lg px-2 py-2 text-sm w-full">
                  </div>

                  <div class="relative">
                    <i class="fas fa-flag absolute left-2 top-3 text-gray-400"></i>
                    <input type="text" name="pasajero_pais_emision_pasaporte_{{ habitacion.id }}_{{ pasajero.id }}" value="{{ pasajero.pais_emision_pasaporte }}"
                           class="pl-8 border rounded-lg px-2 py-2 text-sm w-full" placeholder="{% trans 'Pa√≠s' %}">
                  </div>

                  <div class="col-span-2 flex justify-end">
                    <button type="button" class="bg-rose-100 hover:bg-rose-200 text-rose-700 px-3 py-2 rounded-full eliminar-pasajero" aria-label="{% trans 'Eliminar pasajero' %}">
                      <i class="fas fa-trash text-xs"></i>
                    </button>
                  </div>
                </div>
              {% endfor %}
            </div>

            <div class="mt-4">
              <button type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-full agregar-pasajero" data-hab="{{ forloop.counter }}">
                <i class="fas fa-user-plus mr-2"></i>{% trans "Agregar Pasajero" %}
              </button>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="mt-6 flex justify-between">
        <button type="button" id="agregar-habitacion"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-semibold">
          <i class="fas fa-plus mr-2"></i>{% trans "Agregar Habitaci√≥n" %}
        </button>

        <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full font-semibold">
          <i class="fas fa-save mr-2"></i>{% trans "Guardar Cambios" %}
        </button>
      </div>
    </section>
  </form>
</main>

{# ======= Templates para clonar din√°micamente ======= #}
<template id="tpl-habitacion">
  <div class="bg-white p-6 rounded-2xl shadow border border-gray-200 habitacion-card" data-index="__IDX__">
    <div class="flex justify-between items-center mb-5">
      <h3 class="text-lg font-bold text-indigo-700">{% trans "Habitaci√≥n" %} __IDX__</h3>
      <button type="button" class="bg-rose-100 text-rose-700 hover:bg-rose-200 px-4 py-2 rounded-full eliminar-habitacion">
        <i class="fas fa-trash mr-1"></i>{% trans "Eliminar" %}
      </button>
    </div>

    <div class="grid grid-cols-12 gap-4 mb-4">
      <div class="col-span-3">
        <label class="text-sm text-gray-700">{% trans "Nombre" %}</label>
        <input type="text" name="habitacion_nombre___IDX__" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div class="col-span-3">
        <label class="text-sm text-gray-700">{% trans "Fechas" %}</label>
        <input type="text" name="fechas_viaje___IDX__" class="w-full border rounded-lg px-3 py-2 rango-fechas">
      </div>
      <div class="col-span-2">
        <label class="text-sm text-gray-700">{% trans "Precio" %}</label>
        <input type="number" step="0.01" name="precio___IDX__" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div class="col-span-2">
        <label class="text-sm text-gray-700">{% trans "Adultos" %}</label>
        <input type="number" name="adultos___IDX__" class="w-full border rounded-lg px-3 py-2">
      </div>
      <div class="col-span-2">
        <label class="text-sm text-gray-700">{% trans "Ni√±os" %}</label>
        <input type="number" name="ninos___IDX__" class="w-full border rounded-lg px-3 py-2">
      </div>
    </div>

    <div class="space-y-3 pasajeros-zone"></div>

    <div class="mt-4">
      <button type="button" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-full agregar-pasajero" data-hab="__IDX__">
        <i class="fas fa-user-plus mr-2"></i>{% trans "Agregar Pasajero" %}
      </button>
    </div>
  </div>
</template>

<template id="tpl-pasajero">
  <div class="grid grid-cols-7 gap-2 items-end pasajero-item">
    <input type="hidden" name="pasajero_id___HAB__new___RID__" value="">
    <div class="relative">
      <i class="fas fa-user absolute left-2 top-3 text-gray-400"></i>
      <input type="text" name="pasajero_nombre___HAB__new___RID__" class="pl-8 border rounded-lg px-2 py-2 text-sm w-full" placeholder="{% trans 'Nombre' %}">
    </div>
    <div class="relative">
      <i class="fas fa-calendar-day absolute left-2 top-3 text-gray-400"></i>
      <input type="date" name="pasajero_fecha_nacimiento___HAB__new___RID__" class="pl-8 border rounded-lg px-2 py-2 text-sm w-full">
    </div>
    <div class="relative">
      <i class="fas fa-passport absolute left-2 top-3 text-gray-400"></i>
      <input type="text" name="pasajero_pasaporte___HAB__new___RID__" class="pl-8 border rounded-lg px-2 py-2 text-sm w-full" placeholder="Pasaporte">
    </div>
    <div class="relative">
      <i class="fas fa-calendar-check absolute left-2 top-3 text-gray-400"></i>
      <input type="date" name="pasajero_caducidad_pasaporte___HAB__new___RID__" class="pl-8 border rounded-lg px-2 py-2 text-sm w-full">
    </div>
    <div class="relative">
      <i class="fas fa-flag absolute left-2 top-3 text-gray-400"></i>
      <input type="text" name="pasajero_pais_emision_pasaporte___HAB__new___RID__" class="pl-8 border rounded-lg px-2 py-2 text-sm w-full" placeholder="{% trans 'Pa√≠s' %}">
    </div>
    <div class="col-span-2 flex justify-end">
      <button type="button" class="bg-rose-100 hover:bg-rose-200 text-rose-700 px-3 py-2 rounded-full eliminar-pasajero" aria-label="{% trans 'Eliminar pasajero' %}">
        <i class="fas fa-trash text-xs"></i>
      </button>
    </div>
  </div>
</template>

<!-- Dependencias UI -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<script>
(function() {
  // CSRF para fetch
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

  // Init pickers
  function initPickers(ctx) {
    (ctx || document).querySelectorAll('.rango-fechas').forEach(el => {
      if (el.dataset.drApplied) return;
      $(el).daterangepicker({ locale: { format: 'YYYY-MM-DD' } });
      el.dataset.drApplied = '1';
    });
  }
  initPickers();

  // Agregar habitaci√≥n
  const cont = document.getElementById('habitaciones-container');
  const tplHab = document.getElementById('tpl-habitacion');
  const tplPas = document.getElementById('tpl-pasajero');
  let idx = {{ habitaciones|length|default:0 }};
  let rid = 0;

  document.getElementById('agregar-habitacion')?.addEventListener('click', () => {
    idx += 1;
    const html = tplHab.innerHTML.replaceAll('__IDX__', idx).replaceAll('_IDX__', idx);
    const node = document.createElement('div');
    node.innerHTML = html;
    const block = node.firstElementChild;
    cont.appendChild(block);
    initPickers(block);
  });

  // Eliminar habitaci√≥n/pasajero (delegado)
  document.addEventListener('click', (e) => {
    if (e.target.closest('.eliminar-habitacion')) {
      if (confirm('{% trans "¬øEliminar esta habitaci√≥n?" %}')) {
        e.target.closest('.habitacion-card')?.remove();
      }
    }
    if (e.target.closest('.eliminar-pasajero')) {
      if (confirm('{% trans "¬øEliminar pasajero?" %}')) {
        e.target.closest('.pasajero-item')?.remove();
      }
    }
    if (e.target.closest('.agregar-pasajero')) {
      const btn = e.target.closest('.agregar-pasajero');
      const habIdx = btn.dataset.hab;
      const card = btn.closest('.habitacion-card');
      const zone = card.querySelector('.pasajeros-zone') || card.querySelector('[id^="pasajeros_habitacion_"]') || card;
      rid += 1;
      const html = tplPas.innerHTML
        .replaceAll('__HAB__', habIdx)
        .replaceAll('__RID__', rid);
      const div = document.createElement('div');
      div.innerHTML = html;
      zone.appendChild(div.firstElementChild);
    }
  });

  // Validaci√≥n: confirmada exige n√∫mero confirmaci√≥n
  document.getElementById('form-reserva')?.addEventListener('submit', (e) => {
    const est = document.querySelector('select[name="estatus"]')?.value;
    const num = (document.querySelector('input[name="numero_confirmacion"]')?.value || '').trim();
    if (est === 'confirmada' && !num) {
      e.preventDefault();
      alert('{% trans "Debe ingresar el n√∫mero de confirmaci√≥n para reservas confirmadas." %}');
    }
  });

  // POST ‚ÄúSolicitar Hotel‚Äù sin anidar formularios
  document.getElementById('btn-solicitar-hotel')?.addEventListener('click', async (e) => {
    const url = e.currentTarget.dataset.url;
    try {
      e.currentTarget.disabled = true;
      e.currentTarget.classList.add('opacity-70','cursor-not-allowed');
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
      });
      if (!res.ok) throw new Error('Network');
      alert('{% trans "Solicitud enviada." %}');
    } catch (err) {
      alert('{% trans "No se pudo enviar la solicitud." %}');
    } finally {
      e.currentTarget.disabled = false;
      e.currentTarget.classList.remove('opacity-70','cursor-not-allowed');
    }
  });
})();
</script>
{% endblock %}