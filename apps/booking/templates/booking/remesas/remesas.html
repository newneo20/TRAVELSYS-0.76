{% extends 'booking/base_tabs.html' %}
{% load i18n static %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-10"
     x-data="remesaWizardUltra()"
     x-init="init()">

  <!-- Libs necesarias -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .glass{ background: rgba(255,255,255,.65); backdrop-filter: blur(10px); border:1px solid rgba(0,0,0,.06); }
    .hover-float{ transition: transform .18s ease, box-shadow .18s ease; }
    .hover-float:hover{ transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .skeleton{ background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%); background-size: 400% 100%; animation: sh 1.4s ease infinite; }
    @keyframes sh { 0%{background-position: 100% 50%} 100%{background-position: 0 50%} }
    .focus-ring{ outline:2px solid transparent; outline-offset:2px; }
    .focus-ring:focus{ outline:2px solid #2563eb; outline-offset:2px; }
    .chip{ display:inline-flex; align-items:center; gap:.375rem; padding:.2rem .55rem; border-radius:999px; font-weight:600; font-size:.72rem; border:1px solid #e5e7eb; background:#fff; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; font-weight:700; border-radius:999px; padding:.7rem 1.25rem; }
    .btn-primary{ background:linear-gradient(90deg,#6366f1,#2563eb); color:#fff; }
    .btn-primary:hover{ filter:brightness(1.05); }
    .btn-muted{ background:#fff; border:1px solid #e5e7eb; }
    .btn-muted:hover{ background:#f8fafc; }
    .sticky-actions{ position:sticky; bottom:0; z-index:40; }
  </style>

  <!-- Stepper -->
  <div class="mb-8">
    <div class="flex items-center justify-center gap-4">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full grid place-items-center text-white"
             :class="step >= 1 ? 'bg-indigo-600' : 'bg-gray-300'">1</div>
        <span class="font-semibold" :class="step>=1 ? 'text-gray-900' : 'text-gray-400'">Contactos</span>
      </div>
      <div class="h-0.5 w-12" :class="step>=2 ? 'bg-indigo-600' : 'bg-gray-200'"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full grid place-items-center text-white"
             :class="step >= 2 ? 'bg-indigo-600' : 'bg-gray-300'">2</div>
        <span class="font-semibold" :class="step>=2 ? 'text-gray-900' : 'text-gray-400'">Datos remesa</span>
      </div>
      <div class="h-0.5 w-12" :class="step>=3 ? 'bg-indigo-600' : 'bg-gray-200'"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full grid place-items-center text-white"
             :class="step >= 3 ? 'bg-indigo-600' : 'bg-gray-300'">3</div>
        <span class="font-semibold" :class="step>=3 ? 'text-gray-900' : 'text-gray-400'">Revisión</span>
      </div>
    </div>
  </div>

  <!-- Título -->
  <div class="text-center mb-10">
    <h2 class="text-4xl font-extrabold text-gray-900">
      {% trans "Crear Nueva Remesa" %}
    </h2>
    <p class="text-lg text-gray-500 mt-2">
      {% trans "Completa los datos necesarios para realizar tu remesa de forma segura y eficiente." %}
    </p>
  </div>

  <!-- Barra de búsqueda + acciones rápidas -->
  <div class="glass rounded-xl p-4 mb-8">
    <div class="flex flex-col md:flex-row gap-3 md:items-center">
      <div class="relative flex-1">
        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
        <input type="text"
               x-model="searchImmediate"
               @input="onSearchInput"
               placeholder="Buscar por nombre, teléfono o dirección… (⌘/Ctrl + K)"
               class="pl-10 w-full bg-white/80 border border-white/40 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus-ring focus-ring:focus focus-ring:focus focus-ring"
               aria-label="Buscar contactos">
      </div>
      <div class="flex items-center gap-2">
        <button type="button" class="btn btn-muted focus-ring" @click="clearSearch"><i data-lucide="x"></i> Limpiar</button>
        <span class="chip"><i data-lucide="clock-3" class="w-4 h-4"></i> Actualizado <span x-text="lastSync"></span></span>
      </div>
    </div>
  </div>

  <!-- Modales (existentes) -->
  {% include 'booking/envios/modals/remitente_modal.html' %}
  {% include 'booking/envios/modals/destinatario_modal.html' %}

  <!-- Listados con paginación -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Destinatarios -->
    <section aria-labelledby="dest-title" class="space-y-4">
      <div class="flex items-center justify-between">
        <h4 id="dest-title" class="text-lg font-semibold text-gray-900 flex items-center">
          <i data-lucide="users" class="w-5 h-5 mr-2 text-blue-600"></i>
          Destinatario
        </h4>
        <div class="flex items-center gap-2">
          <button type="button" class="btn btn-muted focus-ring" @click="quickCreate('destinatario')">
            <i data-lucide="sparkles"></i> Rápido
          </button>
          <button type="button" class="btn btn-primary focus-ring" @click="showRecipientModal = true">
            <i data-lucide="plus"></i> Nuevo
          </button>
        </div>
      </div>

      <!-- Estado carga -->
      <template x-if="loadingDestinatarios">
        <div class="space-y-2">
          <div class="h-16 rounded-lg skeleton"></div>
          <div class="h-16 rounded-lg skeleton"></div>
          <div class="h-16 rounded-lg skeleton"></div>
        </div>
      </template>

      <!-- Listado/empty -->
      <div class="space-y-3" x-show="!loadingDestinatarios">
        <template x-if="pagedDestinatarios().length === 0">
          <div class="text-sm text-gray-500 border border-dashed rounded-lg p-4">
            No hay destinatarios que coincidan con la búsqueda.
          </div>
        </template>

        <template x-for="destinatario in pagedDestinatarios()" :key="destinatario.id">
          <button type="button"
                  @click="selectRecipient(destinatario)"
                  class="w-full text-left glass p-4 hover-float rounded-lg border transition"
                  :class="selectedRecipient?.id === destinatario.id ? 'bg-blue-50 border-blue-200' : 'border-transparent hover:bg-white/85'">
            <div class="flex justify-between gap-4">
              <div>
                <h5 class="font-semibold text-gray-900" x-text="destinatario.nombre_completo"></h5>
                <div class="mt-1 space-y-1 text-sm text-gray-600">
                  <div class="flex items-center">
                    <i data-lucide="phone" class="w-4 h-4 mr-2"></i>
                    <span x-text="destinatario.telefono || '—'"></span>
                  </div>
                  <div class="flex items-center">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                    <span x-text="destinatario.direccion_completa || '—'"></span>
                  </div>
                </div>
              </div>
              <div class="min-w-20 text-right">
                <span class="chip" x-show="selectedRecipient?.id === destinatario.id"><i data-lucide="check"></i> Seleccionado</span>
              </div>
            </div>
          </button>
        </template>
      </div>

      <!-- Paginación -->
      <div class="flex items-center justify-between pt-1" x-show="!loadingDestinatarios">
        <p class="text-xs text-gray-500">
          <span x-text="pageDest+1"></span>/<span x-text="totalPagesDest()"></span> páginas — <span x-text="destinatarios.length"></span> registros
        </p>
        <div class="flex items-center gap-2">
          <button class="btn btn-muted focus-ring" :disabled="pageDest===0" @click="pageDest--"><i data-lucide="chevron-left"></i> Anterior</button>
          <button class="btn btn-muted focus-ring" :disabled="pageDest>=totalPagesDest()-1" @click="pageDest++">Siguiente <i data-lucide="chevron-right"></i></button>
        </div>
      </div>
    </section>

    <!-- Remitentes -->
    <section aria-labelledby="remit-title" class="space-y-4">
      <div class="flex items-center justify-between">
        <h4 id="remit-title" class="text-lg font-semibold text-gray-900 flex items-center">
          <i data-lucide="user-round" class="w-5 h-5 mr-2 text-green-600"></i>
          Remitente
        </h4>
        <div class="flex items-center gap-2">
          <button type="button" class="btn btn-muted focus-ring" @click="quickCreate('remitente')">
            <i data-lucide="sparkles"></i> Rápido
          </button>
          <button type="button" class="btn btn-primary focus-ring" @click="showSenderModal = true">
            <i data-lucide="plus"></i> Nuevo
          </button>
        </div>
      </div>

      <!-- Estado carga -->
      <template x-if="loadingRemitentes">
        <div class="space-y-2">
          <div class="h-16 rounded-lg skeleton"></div>
          <div class="h-16 rounded-lg skeleton"></div>
          <div class="h-16 rounded-lg skeleton"></div>
        </div>
      </template>

      <!-- Listado/empty -->
      <div class="space-y-3" x-show="!loadingRemitentes">
        <template x-if="pagedRemitentes().length === 0">
          <div class="text-sm text-gray-500 border border-dashed rounded-lg p-4">
            No hay remitentes que coincidan con la búsqueda.
          </div>
        </template>

        <template x-for="remitente in pagedRemitentes()" :key="remitente.id">
          <button type="button"
                  @click="selectSender(remitente)"
                  class="w-full text-left glass p-4 hover-float rounded-lg border transition"
                  :class="selectedSender?.id === remitente.id ? 'bg-green-50 border-green-200' : 'border-transparent hover:bg-white/85'">
            <div class="flex justify-between gap-4">
              <div>
                <h5 class="font-semibold text-gray-900" x-text="remitente.nombre_apellido"></h5>
                <div class="mt-1 space-y-1 text-sm text-gray-600">
                  <div class="flex items-center">
                    <i data-lucide="phone" class="w-4 h-4 mr-2"></i>
                    <span x-text="remitente.telefono || '—'"></span>
                  </div>
                  <div class="flex items-center">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                    <span x-text="remitente.direccion || '—'"></span>
                  </div>
                </div>
              </div>
              <div class="min-w-20 text-right">
                <span class="chip" x-show="selectedSender?.id === remitente.id"><i data-lucide="check"></i> Seleccionado</span>
              </div>
            </div>
          </button>
        </template>
      </div>

      <!-- Paginación -->
      <div class="flex items-center justify-between pt-1" x-show="!loadingRemitentes">
        <p class="text-xs text-gray-500">
          <span x-text="pageRem+1"></span>/<span x-text="totalPagesRem()"></span> páginas — <span x-text="remitentes.length"></span> registros
        </p>
        <div class="flex items-center gap-2">
          <button class="btn btn-muted focus-ring" :disabled="pageRem===0" @click="pageRem--"><i data-lucide="chevron-left"></i> Anterior</button>
          <button class="btn btn-muted focus-ring" :disabled="pageRem>=totalPagesRem()-1" @click="pageRem++">Siguiente <i data-lucide="chevron-right"></i></button>
        </div>
      </div>
    </section>
  </div>

  <!-- Resumen de selección -->
  <div x-show="selectedRecipient || selectedSender"
       x-transition
       class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl border border-blue-200 mt-8">
    <h5 class="font-semibold text-gray-900 mb-3">Resumen de Contactos</h5>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="flex items-center gap-3" x-show="selectedRecipient">
        <div class="w-8 h-8 bg-blue-600 rounded-full grid place-items-center text-white">
          <i data-lucide="user"></i>
        </div>
        <div>
          <p class="font-medium text-gray-900">Destinatario</p>
          <p class="text-sm text-gray-600" x-text="selectedRecipient?.nombre_completo"></p>
        </div>
      </div>
      <div class="flex items-center gap-3" x-show="selectedSender">
        <div class="w-8 h-8 bg-green-600 rounded-full grid place-items-center text-white">
          <i data-lucide="user"></i>
        </div>
        <div>
          <p class="font-medium text-gray-900">Remitente</p>
          <p class="text-sm text-gray-600" x-text="selectedSender?.nombre_apellido"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Paso 2: Datos de la Remesa -->
  <div class="mt-10 bg-white shadow-lg rounded-2xl p-8 border border-gray-200">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-indigo-700">
        {% trans "Datos de la Remesa" %}
      </h3>
      <div class="text-sm text-gray-500 space-x-2">
        <span class="chip"><i data-lucide="banknote"></i> USD/CUP/MLC</span>
        <span class="chip"><i data-lucide="shield-check"></i> Validaciones activas</span>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <!-- Monto -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Monto a enviar" %}</label>
        <div class="flex rounded-xl overflow-hidden border border-gray-300 focus-within:ring-2 focus-within:ring-blue-500">
          <input type="number" min="1" step="0.01" x-model.number="monto"
                 class="w-full px-4 py-3 border-0 focus:ring-0"
                 placeholder="0.00" inputmode="decimal" aria-label="Monto a enviar">
          <select x-model="moneda" class="border-0 border-l px-3 py-3 bg-gray-50 focus:ring-0" aria-label="Moneda de envío">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <p class="text-xs text-gray-500 mt-1" x-show="monto <= 0">Ingresa un monto mayor a cero.</p>
      </div>

      <!-- Moneda de recepción -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Moneda de recepción" %}</label>
        <select x-model="moneda_recepcion" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" aria-label="Moneda de recepción">
          <option value="CUP">CUP</option>
          <option value="MLC">MLC</option>
          <option value="USD">USD</option>
        </select>
      </div>

      <!-- Monto estimado -->
      <div class="md:col-span-2">
        <div class="flex items-center justify-between">
          <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Monto estimado de recepción" %}</label>
          <span class="text-xs"
                :class="tasaValida ? 'text-gray-500' : 'text-amber-700 font-medium'"
                x-text="textoTasa()"></span>
        </div>
        <input type="text" x-model="monto_estimado"
               class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100"
               readonly aria-readonly="true" aria-label="Monto estimado">
        <p class="text-xs mt-1"
           :class="tasaValida ? 'text-gray-400' : 'text-amber-700'">
          <template x-if="tasaValida">
            <span>{% trans "Cálculo basado en la tasa de cambio actual." %}</span>
          </template>
          <template x-if="!tasaValida">
            <span>Falta tasa para {{ moneda }} → {{ moneda_recepcion }}. Ajusta las tasas o cambia las monedas.</span>
          </template>
        </p>
      </div>
    </div>
  </div>

  <!-- Paso 3: Revisión -->
  <div class="mt-8 bg-white shadow rounded-2xl p-6 border border-gray-200">
    <h3 class="text-xl font-bold text-gray-900 mb-4">Revisión</h3>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="glass rounded-lg p-4">
        <p class="text-xs text-gray-500 mb-1">Remitente</p>
        <p class="font-semibold text-gray-900" x-text="selectedSender?.nombre_apellido || '—'"></p>
        <p class="text-sm text-gray-600" x-text="selectedSender?.telefono || ''"></p>
      </div>
      <div class="glass rounded-lg p-4">
        <p class="text-xs text-gray-500 mb-1">Destinatario</p>
        <p class="font-semibold text-gray-900" x-text="selectedRecipient?.nombre_completo || '—'"></p>
        <p class="text-sm text-gray-600" x-text="selectedRecipient?.telefono || ''"></p>
      </div>
      <div class="glass rounded-lg p-4">
        <p class="text-xs text-gray-500 mb-1">Resumen</p>
        <p class="text-sm text-gray-700">
          <span class="font-semibold" x-text="monto > 0 ? (monto.toFixed(2) + ' ' + moneda) : '—'"></span>
          →
          <span class="font-semibold" x-text="monto_estimado ? (monto_estimado + ' ' + moneda_recepcion) : '—'"></span>
        </p>
      </div>
    </div>
  </div>

  <!-- Acciones pegajosas -->
  <div class="sticky-actions mt-8">
    <div class="glass rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3 border">
      <div class="text-sm text-gray-600">
        <span class="chip"><i data-lucide="info"></i> Selecciona remitente y destinatario</span>
        <span class="chip"><i data-lucide="check-circle-2"></i> Monto válido</span>
        <span class="chip"><i data-lucide="scale"></i> Tasa disponible</span>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" class="btn btn-muted focus-ring" @click="goPrev" :disabled="step===1"><i data-lucide="chevron-left"></i> Anterior</button>
        <button type="button" class="btn btn-muted focus-ring" @click="goNext" :disabled="step===3 || !canAdvance()">
          Siguiente <i data-lucide="chevron-right"></i>
        </button>
        <button type="button"
                class="btn btn-primary focus-ring"
                @click="enviarRemesa"
                :disabled="!formValido">
          <i data-lucide="send"></i> {% trans "Enviar Remesa" %}
        </button>
      </div>
    </div>
  </div>

  <!-- CSRF oculto -->
  <form class="hidden">{% csrf_token %}</form>

  <!-- TOASTS -->
  <div class="fixed top-4 right-4 space-y-2 z-50">
    <template x-for="t in toasts" :key="t.id">
      <div class="rounded-xl shadow-lg px-4 py-3 text-white"
           :class="t.type==='ok' ? 'bg-emerald-600' : (t.type==='warn' ? 'bg-amber-600' : 'bg-rose-600')">
        <div class="flex items-start gap-2">
          <i :data-lucide="t.icon || (t.type==='ok' ? 'check-circle-2' : (t.type==='warn' ? 'alert-triangle' : 'x-circle'))"></i>
          <div>
            <p class="font-semibold" x-text="t.title"></p>
            <p class="text-sm opacity-90" x-text="t.msg"></p>
          </div>
        </div>
      </div>
    </template>
  </div>
</div>

<!-- Datos iniciales -->
<script id="datos-iniciales" type="application/json">
  {{ json_contactos|safe }}
</script>

<script>
function remesaWizardUltra(){
  return {
    // Paso actual
    step: 1,

    // Estados UI
    loadingDestinatarios: true,
    loadingRemitentes: true,

    // Datos base
    destinatarios: [],
    remitentes: [],

    // Selección
    selectedSender: null,
    selectedRecipient: null,

    // Búsqueda + debounce + atajos
    searchImmediate: '',
    searchQuery: '',
    _searchTimer: null,
    lastSync: 'ahora',

    // Paginación
    pageDest: 0,
    pageRem: 0,
    pageSize: 6,

    // Remesa
    monto: 0,
    moneda: 'USD',
    moneda_recepcion: 'CUP',
    monto_estimado: '',
    tasaValida: true,

    // Tasas desde backend
    tasa_cup: {{ tasa_cambio.tasa_cup|default:0 }},
    tasa_mlc: {{ tasa_cambio.tasa_mlc|default:0 }},
    // (Si luego agregas EUR->CUP/MLC, define tasa_cup_eur y tasa_mlc_eur)

    // Toasts
    toasts: [],

    get formValido(){
      return !!(this.selectedSender && this.selectedRecipient && this.monto > 0 && this.tasaValida && this.monto_estimado !== '');
    },

    init(){
      // Cargar datos seguros
      const raw = document.getElementById('datos-iniciales').textContent || '{}';
      let datos = {};
      try { datos = JSON.parse(raw); } catch(e){ datos = {}; }
      this.destinatarios = Array.isArray(datos.destinatarios) ? datos.destinatarios : [];
      this.remitentes    = Array.isArray(datos.remitentes) ? datos.remitentes : [];

      // Simular carga/latencia inicial breve (mejor UX)
      setTimeout(() => { this.loadingDestinatarios = false; }, 250);
      setTimeout(() => { this.loadingRemitentes = false; }, 300);

      // Recordar última selección
      this.restoreLastSelection();

      // Watchers
      this.$watch('moneda', this.calcularEstimado);
      this.$watch('moneda_recepcion', this.calcularEstimado);
      this.$watch('monto', this.calcularEstimado);
      this.$watch('selectedSender',  () => { this.persistLastSelection(); this._icons(); });
      this.$watch('selectedRecipient', () => { this.persistLastSelection(); this._icons(); });

      // Atajos de teclado
      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); document.querySelector('input[placeholder*="Buscar"]').focus(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='enter'){ e.preventDefault(); if (this.formValido) this.enviarRemesa(); }
      });

      this.$nextTick(() => { this.calcularEstimado(); this._icons(); this.tickLastSync(); });
    },

    // Progreso
    canAdvance(){
      if (this.step === 1) return !!(this.selectedSender && this.selectedRecipient);
      if (this.step === 2) return !!(this.monto > 0 && this.tasaValida && this.monto_estimado);
      return true;
    },
    goNext(){ if (this.step < 3 && this.canAdvance()) this.step++; },
    goPrev(){ if (this.step > 1) this.step--; },

    // Buscar con debounce
    onSearchInput(e){
      clearTimeout(this._searchTimer);
      const val = e.target.value || '';
      this._searchTimer = setTimeout(() => {
        this.searchQuery = val;
        this.pageDest = 0; this.pageRem = 0;
        this._icons();
      }, 180);
    },
    clearSearch(){ this.searchImmediate=''; this.searchQuery=''; this.pageDest=0; this.pageRem=0; this._icons(); },

    // Normalizar
    _norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); },

    // Filtros
    filteredDestinatarios(){
      const q = this._norm(this.searchQuery);
      if (!q) return this.destinatarios;
      return this.destinatarios.filter(d =>
        this._norm(d.nombre_completo).includes(q) ||
        this._norm(d.telefono).includes(q) ||
        this._norm(d.direccion_completa).includes(q)
      );
    },
    filteredRemitentes(){
      const q = this._norm(this.searchQuery);
      if (!q) return this.remitentes;
      return this.remitentes.filter(r =>
        this._norm(r.nombre_apellido).includes(q) ||
        this._norm(r.telefono).includes(q) ||
        this._norm(r.direccion || '').includes(q)
      );
    },

    // Paginación helpers
    totalPagesDest(){ return Math.max(1, Math.ceil(this.filteredDestinatarios().length / this.pageSize)); },
    totalPagesRem(){  return Math.max(1, Math.ceil(this.filteredRemitentes().length  / this.pageSize)); },
    pagedDestinatarios(){
      const start = this.pageDest * this.pageSize;
      return this.filteredDestinatarios().slice(start, start + this.pageSize);
    },
    pagedRemitentes(){
      const start = this.pageRem * this.pageSize;
      return this.filteredRemitentes().slice(start, start + this.pageSize);
    },

    // Selección + persistencia
    selectRecipient(d){ this.selectedRecipient = d; this.toast('ok','Destinatario seleccionado','Se ha establecido el destinatario.'); },
    selectSender(r){ this.selectedSender = r; this.toast('ok','Remitente seleccionado','Se ha establecido el remitente.'); },
    persistLastSelection(){
      try {
        localStorage.setItem('remesa:last', JSON.stringify({
          senderId: this.selectedSender?.id || null,
          recipientId: this.selectedRecipient?.id || null
        }));
      } catch(e){}
    },
    restoreLastSelection(){
      try{
        const s = localStorage.getItem('remesa:last');
        if (!s) return;
        const {senderId, recipientId} = JSON.parse(s);
        if (senderId){ this.selectedSender = this.remitentes.find(r=>r.id===senderId) || null; }
        if (recipientId){ this.selectedRecipient = this.destinatarios.find(d=>d.id===recipientId) || null; }
      } catch(e){}
    },

    // Ticker “Actualizado”
    tickLastSync(){
      const upd = () => {
        this.lastSync = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
        setTimeout(upd, 60_000);
      };
      upd();
    },

    // Quick create inline (demo minimalista)
    quickCreate(tipo){
      if (tipo==='destinatario'){
        const id = 'D' + Math.random().toString(36).slice(2,7);
        const nuevo = { id, nombre_completo:'Nuevo Destinatario', telefono:'', direccion_completa:'' };
        this.destinatarios.unshift(nuevo); this.pageDest=0; this.selectRecipient(nuevo); this._icons();
      } else {
        const id = 'R' + Math.random().toString(36).slice(2,7);
        const nuevo = { id, nombre_apellido:'Nuevo Remitente', telefono:'', direccion:'' };
        this.remitentes.unshift(nuevo); this.pageRem=0; this.selectSender(nuevo); this._icons();
      }
    },

    // Cálculo de tasas
    textoTasa(){
      if (this.moneda === this.moneda_recepcion) return 'Sin conversión';
      if (!this.tasaValida) return 'Tasa no disponible';
      if (this.moneda==='USD' && this.moneda_recepcion==='CUP') return `1 USD = ${this.tasa_cup} CUP`;
      if (this.moneda==='USD' && this.moneda_recepcion==='MLC') return `1 USD = ${this.tasa_mlc} MLC`;
      // Si añades tasas EUR->CUP/MLC:
      // if (this.moneda==='EUR' && this.moneda_recepcion==='CUP') return `1 EUR = ${this.tasa_cup_eur} CUP`;
      // if (this.moneda==='EUR' && this.moneda_recepcion==='MLC') return `1 EUR = ${this.tasa_mlc_eur} MLC`;
      return '';
    },
    calcularEstimado(){
      const monto = parseFloat(this.monto || 0);
      let tasa = 1; this.tasaValida = true;

      if (this.moneda === this.moneda_recepcion) tasa = 1;
      else if (this.moneda==='USD' && this.moneda_recepcion==='CUP') { tasa = parseFloat(this.tasa_cup||0); if(!tasa) this.tasaValida=false; }
      else if (this.moneda==='USD' && this.moneda_recepcion==='MLC'){ tasa = parseFloat(this.tasa_mlc||0); if(!tasa) this.tasaValida=false; }
      else {
        // EUR u otras combinaciones: marcar inválido hasta que agregues tasas
        // (agrega tasa_cup_eur, tasa_mlc_eur y extiende este bloque)
        this.tasaValida=false;
      }

      if (!this.tasaValida || isNaN(monto) || monto <= 0){ this.monto_estimado=''; return; }
      const est = monto * tasa;
      this.monto_estimado = isNaN(est) ? '' : est.toFixed(2);
    },

    // Envío
    async enviarRemesa(){
      if (!this.formValido){ this.toast('warn','Faltan datos','Verifica contactos, monto y tasas.'); return; }

      try{
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const resp = await fetch("{% url 'booking:guardar_remesa' %}", {
          method: "POST",
          headers: {"Content-Type":"application/json","X-CSRFToken":csrf},
          body: JSON.stringify({
            remitente_id: this.selectedSender.id,
            destinatario_id: this.selectedRecipient.id,
            montoEnvio: this.monto,
            monedaEnvio: this.moneda,
            monedaRecepcion: this.moneda_recepcion
          })
        });

        if (resp.redirected){ window.location.href = resp.url; return; }
        const data = await resp.json().catch(()=> ({}));
        if (data?.ok && data?.redirect_url){ window.location.href = data.redirect_url; return; }
        if (!resp.ok){ this.toast('err','Error al enviar','No se pudo completar la remesa.'); return; }

        this.toast('ok','Remesa enviada','Se ha procesado correctamente.');
      }catch(e){
        console.error(e);
        this.toast('err','Error inesperado','Inténtalo nuevamente.');
      }
    },

    // Toasts
    toast(type='ok', title='Hecho', msg=''){
      const id = Math.random().toString(36).slice(2,8);
      this.toasts.push({id,type,title,msg});
      this.$nextTick(()=>this._icons());
      setTimeout(()=>{ this.toasts = this.toasts.filter(t=>t.id!==id); }, 3500);
    },

    // Lucide
    _icons(){ if (window.lucide) window.lucide.createIcons(); }
  }
}
</script>
{% endblock %}
