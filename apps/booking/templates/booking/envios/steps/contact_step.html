<!-- contact_step.html -->
<div>
    <h3 class="text-2xl font-bold text-gray-900 mb-2">Información de Contacto</h3>
    <p class="text-gray-600">Selecciona o crea nuevos contactos para el envío.</p>
  </div>
  
  <!-- Search Bar (debounce + limpiar) -->
  <div class="glass glassmorphism p-4 rounded-lg mb-6">
    <div class="flex gap-2 items-center">
      <div class="relative flex-1">
        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
        <input
          type="text"
          x-model="searchImmediate"
          @input="onSearchInput($event)"
          placeholder="Buscar por nombre, teléfono o dirección…"
          class="pl-10 w-full bg-white/70 border border-white/30 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          aria-label="Buscar contactos"
        />
      </div>
      <button type="button"
              class="px-3 py-2 text-sm rounded-lg border border-gray-300 bg-white hover:bg-gray-50"
              @click="clearSearch">
        Limpiar
      </button>
    </div>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Destinatario -->
    <section aria-labelledby="destinatario-title" class="space-y-4">
      <div class="flex items-center justify-between">
        <h4 id="destinatario-title" class="text-lg font-semibold text-gray-900 flex items-center">
          <i data-lucide="users" class="w-5 h-5 mr-2 text-blue-600"></i>
          Destinatario
        </h4>
        <button
          type="button"
          @click="showRecipientModal = true"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"
        >
          <i data-lucide="plus" class="w-4 h-4 mr-1 inline"></i>
          Nuevo
        </button>
      </div>
  
      <!-- Empty / List -->
      <template x-if="filteredDestinatarios().length === 0">
        <div class="text-sm text-gray-500 border border-dashed rounded-lg p-4">
          No hay destinatarios que coincidan con la búsqueda.
        </div>
      </template>
  
      <div class="space-y-3">
        <template x-for="destinatario in filteredDestinatarios()" :key="destinatario.id">
          <button type="button"
                  @click="selectRecipient(destinatario)"
                  class="w-full text-left glass glassmorphism p-4 rounded-lg transition hover:shadow-sm border"
                  :class="selectedRecipient?.id === destinatario.id ? 'bg-blue-50 border-blue-200' : 'border-transparent hover:bg-white/80'"
                  :aria-pressed="selectedRecipient?.id === destinatario.id"
                  :aria-label="`Seleccionar destinatario ${destinatario.nombre_completo}`">
            <div class="flex justify-between gap-4">
              <div class="flex-1">
                <h5 class="font-semibold text-gray-900" x-text="destinatario.nombre_completo"></h5>
                <div class="space-y-1 text-sm text-gray-600 mt-1">
                  <div class="flex items-center">
                    <i data-lucide="phone" class="w-4 h-4 mr-2"></i>
                    <span x-text="destinatario.telefono || '—'"></span>
                  </div>
                  <div class="flex items-center">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                    <span x-text="destinatario.direccion_completa || '—'"></span>
                  </div>
                </div>
              </div>
              <div class="min-w-20 text-right" x-show="selectedRecipient?.id === destinatario.id">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                  <i data-lucide="check" class="w-3.5 h-3.5"></i> Seleccionado
                </span>
              </div>
            </div>
          </button>
        </template>
      </div>
    </section>
  
    <!-- Remitente -->
    <section aria-labelledby="remitente-title" class="space-y-4">
      <div class="flex items-center justify-between">
        <h4 id="remitente-title" class="text-lg font-semibold text-gray-900 flex items-center">
          <i data-lucide="user-round" class="w-5 h-5 mr-2 text-green-600"></i>
          Remitente
        </h4>
        <button
          type="button"
          @click="showSenderModal = true"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"
        >
          <i data-lucide="plus" class="w-4 h-4 mr-1 inline"></i>
          Nuevo
        </button>
      </div>
  
      <!-- Empty / List -->
      <template x-if="filteredRemitentes().length === 0">
        <div class="text-sm text-gray-500 border border-dashed rounded-lg p-4">
          No hay remitentes que coincidan con la búsqueda.
        </div>
      </template>
  
      <div class="space-y-3">
        <template x-for="remitente in filteredRemitentes()" :key="remitente.id">
          <button type="button"
                  @click="selectSender(remitente)"
                  class="w-full text-left glass glassmorphism p-4 rounded-lg transition hover:shadow-sm border"
                  :class="selectedSender?.id === remitente.id ? 'bg-green-50 border-green-200' : 'border-transparent hover:bg-white/80'"
                  :aria-pressed="selectedSender?.id === remitente.id"
                  :aria-label="`Seleccionar remitente ${remitente.nombre_apellido}`">
            <div class="flex justify-between gap-4">
              <div class="flex-1">
                <h5 class="font-semibold text-gray-900" x-text="remitente.nombre_apellido"></h5>
                <div class="space-y-1 text-sm text-gray-600 mt-1">
                  <div class="flex items-center">
                    <i data-lucide="phone" class="w-4 h-4 mr-2"></i>
                    <span x-text="remitente.telefono || '—'"></span>
                  </div>
                  <div class="flex items-center">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                    <span x-text="remitente.direccion || '—'"></span>
                  </div>
                </div>
              </div>
              <div class="min-w-20 text-right" x-show="selectedSender?.id === remitente.id">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                  <i data-lucide="check" class="w-3.5 h-3.5"></i> Seleccionado
                </span>
              </div>
            </div>
          </button>
        </template>
      </div>
    </section>
  </div>
  
  <!-- Resumen -->
  <div x-show="selectedRecipient || selectedSender"
       x-transition
       class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl border border-blue-200 mt-6">
    <h5 class="font-semibold text-gray-900 mb-3">Resumen de Contactos</h5>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="flex items-center gap-3" x-show="selectedRecipient">
        <div class="w-8 h-8 bg-blue-600 rounded-full grid place-items-center text-white">
          <i data-lucide="user"></i>
        </div>
        <div>
          <p class="font-medium text-gray-900">Destinatario</p>
          <p class="text-sm text-gray-600" x-text="selectedRecipient?.nombre_completo"></p>
        </div>
      </div>
      <div class="flex items-center gap-3" x-show="selectedSender">
        <div class="w-8 h-8 bg-green-600 rounded-full grid place-items-center text-white">
          <i data-lucide="user"></i>
        </div>
        <div>
          <p class="font-medium text-gray-900">Remitente</p>
          <p class="text-sm text-gray-600" x-text="selectedSender?.nombre_apellido"></p>
        </div>
      </div>
    </div>
  </div>
  