{% extends 'booking/base_tabs.html' %}
{% load static i18n %}

{% block title %}Crear Envío - TRAVEL-SYS{% endblock %}

{% block content %}

<style>
  /* x-cloak para Alpine */
  [x-cloak]{ display:none !important; }

  /* Estética y microinteracciones */
  .glass{ background: rgba(255,255,255,.7); backdrop-filter: blur(10px); border:1px solid rgba(0,0,0,.06); }
  .hover-float{ transition: transform .18s ease, box-shadow .18s ease; }
  .hover-float:hover{ transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,.08); }
  .skeleton{ background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%); background-size: 400% 100%; animation: sh 1.4s ease infinite; }
  @keyframes sh{ 0%{background-position:100% 50%}100%{background-position:0 50%} }
  .focus-ring{ outline:2px solid transparent; outline-offset:2px; }
  .focus-ring:focus{ outline:2px solid #2563eb; outline-offset:2px; }
  .chip{ display:inline-flex; align-items:center; gap:.375rem; padding:.2rem .55rem; border-radius:999px; font-weight:600; font-size:.72rem; border:1px solid #e5e7eb; background:#fff; }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; font-weight:700; border-radius:999px; padding:.7rem 1.25rem; }
  .btn-primary{ background:linear-gradient(90deg,#6366f1,#2563eb); color:#fff; }
  .btn-primary:hover{ filter:brightness(1.05); }
  .btn-muted{ background:#fff; border:1px solid #e5e7eb; }
  .btn-muted:hover{ background:#f8fafc; }
  .sticky-actions{ position:sticky; bottom:0; z-index:40; }
</style>

<!-- Datos iniciales seguros -->
<script id="datos-iniciales" type="application/json">
  {{ datos_iniciales|safe }}
</script>

<div class="min-h-screen gradient-bg">
  <main class="max-w-7xl mx-auto px-6 py-8">
    <div x-data="shippingWizardPro()" x-init="init()" class="space-y-8 animate-fade-in">

      <!-- Encabezado -->
      <div class="text-center">
        <h2 class="text-4xl font-bold text-gray-900 mb-4">Crear Nueva Reserva de Envío</h2>
        <p class="text-xl text-gray-600">Completa los pasos para crear tu envío de manera rápida y segura</p>
      </div>

      <!-- Progreso + pasos -->
      <div class="glass p-6 rounded-2xl">
        <div class="mb-6">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Progreso</span>
            <span class="text-sm text-gray-500" x-text="Math.round(progress) + '% completado'"></span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 h-2 rounded-full transition-all duration-500"
                 :style="`width: ${progress}%`"></div>
          </div>
        </div>

        <div class="flex items-center justify-between">
          <template x-for="(s, idx) in steps" :key="s.id">
            <div class="flex items-center">
              <button type="button"
                      @click="goToStep(s.id)"
                      :disabled="!isStepAccessible(s.id)"
                      class="flex items-center space-x-3 p-3 rounded-lg transition-all"
                      :class="{
                        'bg-blue-100 text-blue-700 shadow-sm': currentStep === s.id,
                        'bg-green-100 text-green-700 hover:bg-green-200': isStepCompleted(s.id),
                        'text-gray-600 hover:bg-gray-100': isStepAccessible(s.id) && currentStep !== s.id && !isStepCompleted(s.id),
                        'text-gray-400 cursor-not-allowed': !isStepAccessible(s.id)
                      }">
                <div class="w-10 h-10 rounded-full grid place-items-center"
                     :class="{
                       'bg-blue-600 text-white': currentStep === s.id,
                       'bg-green-600 text-white': isStepCompleted(s.id),
                       'bg-gray-200 text-gray-700': isStepAccessible(s.id) && currentStep !== s.id && !isStepCompleted(s.id),
                       'bg-gray-100 text-gray-400': !isStepAccessible(s.id)
                     }">
                  <template x-if="isStepCompleted(s.id)">
                    <i data-lucide="check" class="w-5 h-5"></i>
                  </template>
                  <template x-if="!isStepCompleted(s.id)">
                    <i :data-lucide="s.icon" class="w-5 h-5"></i>
                  </template>
                </div>
                <div class="text-left hidden md:block">
                  <div class="font-medium" x-text="s.name"></div>
                  <div class="text-xs opacity-75" x-text="s.description"></div>
                </div>
              </button>
              <div x-show="idx < steps.length - 1" class="w-8 h-px bg-gray-300 mx-2 hidden md:block"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Contenido del paso -->
      <div class="glass p-8 rounded-2xl min-h-[600px]">
        <!-- Paso 1: Contactos -->
        <template x-if="currentStep === 1">
          <div x-transition class="space-y-8">
            {% include 'booking/envios/steps/contact_step.html' %}
          </div>
        </template>

        <!-- Paso 2: Artículos -->
        <template x-if="currentStep === 2">
          <div x-transition class="space-y-8">
            {% include 'booking/envios/steps/items_step.html' %}
          </div>
        </template>

        <!-- Paso 3: Revisión -->
        <template x-if="currentStep === 3">
          <div x-transition class="space-y-8">
            {% include 'booking/envios/steps/review_step.html' %}
          </div>
        </template>

        <!-- Navegación -->
        <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
          <button type="button"
                  @click="previousStep()"
                  :disabled="currentStep === 1"
                  class="flex items-center space-x-2 px-6 py-3 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all focus-ring">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
            <span>Anterior</span>
          </button>

          <button type="button"
                  @click="nextStep()"
                  :disabled="isProcessing || (currentStep < 3 && !canAdvance())"
                  class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium transition-all focus-ring disabled:opacity-60 disabled:cursor-not-allowed">
            <span x-text="currentStep === 3 ? 'Finalizar' : 'Siguiente'"></span>
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Modales dentro del scope Alpine -->
      {% include 'booking/envios/modals/destinatario_modal.html' %}
      {% include 'booking/envios/modals/remitente_modal.html' %}

      <!-- Barra pegajosa con acciones rápidas -->
      <div class="sticky-actions">
        <div class="glass rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3 border">
          <div class="text-sm text-gray-600">
            <span class="chip"><i data-lucide="keyboard"></i> ⌘/Ctrl + K buscar</span>
            <span class="chip"><i data-lucide="corner-down-left"></i> ⌘/Ctrl + Enter enviar</span>
            <span class="chip"><i data-lucide="clock-3"></i> <span x-text="lastSync"></span></span>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="btn btn-muted focus-ring" @click="clearSearch"><i data-lucide="x"></i> Limpiar</button>
            <button type="button" class="btn btn-primary focus-ring" @click="goToStep(3)" :disabled="!canAdvanceToReview()">Revisar</button>
          </div>
        </div>
      </div>

      <!-- TOASTS -->
      <div class="fixed top-4 right-4 space-y-2 z-50" x-cloak>
        <template x-for="t in toasts" :key="t.id">
          <div class="rounded-xl shadow-lg px-4 py-3 text-white"
               :class="t.type==='ok' ? 'bg-emerald-600' : (t.type==='warn' ? 'bg-amber-600' : 'bg-rose-600')">
            <div class="flex items-start gap-2">
              <i :data-lucide="t.icon || (t.type==='ok' ? 'check-circle-2' : (t.type==='warn' ? 'alert-triangle' : 'x-circle'))"></i>
              <div>
                <p class="font-semibold" x-text="t.title"></p>
                <p class="text-sm opacity-90" x-text="t.msg"></p>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- CSRF oculto -->
      <form class="hidden">{% csrf_token %}</form>
    </div>
  </main>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
  const URL_CREAR_RESERVA_ENVIO = "{% url 'booking:crear_reserva_envio_final' %}";
</script>

<script>
function shippingWizardPro(){
  return {
    /* ====== Estado base ====== */
    currentStep: 1,
    steps: [
      { id:1, name:'Contactos', icon:'users',    description:'Destinatario y remitente' },
      { id:2, name:'Artículos', icon:'package',  description:'Items del envío' },
      { id:3, name:'Revisión',  icon:'file-text',description:'Confirmar detalles' }
    ],
    completedSteps: [],

    // Catálogos
    provinciasDisponibles: {
      'Pinar del Río':['Consolación del Sur','Guane','La Palma','Los Palacios','Mantua','Minas de Matahambre','Pinar del Río','San Juan y Martínez','San Luis','Sandino','Viñales'],
      'Artemisa':['Alquízar','Artemisa','Bauta','Caimito','Guanajay','Güira de Melena','Mariel','San Antonio de los Baños','San Cristóbal','Bahía Honda','Candelaria'],
      'La Habana':['Arroyo Naranjo','Boyeros','Centro Habana','Cerro','Cotorro','Diez de Octubre','Guanabacoa','Habana del Este','Habana Vieja','La Lisa','Marianao','Playa','Plaza de la Revolución','Regla','San Miguel del Padrón'],
      'Mayabeque':['Batabanó','Bejucal','Güines','Jaruco','Madruga','Melena del Sur','Nueva Paz','Quivicán','San José de las Lajas','San Nicolás de Bari','Santa Cruz del Norte'],
      'Matanzas':['Calimete','Cárdenas','Ciénaga de Zapata','Colón','Jagüey Grande','Jovellanos','Limonar','Los Arabos','Martí','Matanzas','Pedro Betancourt','Perico','Unión de Reyes'],
      'Villa Clara':['Caibarién','Camajuaní','Cifuentes','Corralillo','Encrucijada','Manicaragua','Placetas','Quemado de Güines','Ranchuelo','Remedios','Sagua la Grande','Santa Clara','Santo Domingo'],
      'Cienfuegos':['Abreus','Aguada de Pasajeros','Cienfuegos','Cruces','Cumanayagua','Lajas','Palmira','Rodas'],
      'Sancti Spíritus':['Cabaiguán','Fomento','Jatibonico','La Sierpe','Sancti Spíritus','Taguasco','Trinidad','Yaguajay'],
      'Ciego de Ávila':['Baraguá','Bolivia','Chambas','Ciego de Ávila','Ciro Redondo','Florencia','Majagua','Morón','Primero de Enero','Venezuela'],
      'Camagüey':['Camagüey','Carlos Manuel de Céspedes','Esmeralda','Florida','Guáimaro','Jimaguayú','Minas','Najasa','Nuevitas','Santa Cruz del Sur','Sibanicú','Sierra de Cubitas','Vertientes'],
      'Las Tunas':['Amancio','Colombia','Jesús Menéndez','Jobabo','Las Tunas','Majibacoa','Manatí','Puerto Padre'],
      'Holguín':['Antilla','Báguanos','Banes','Cacocum','Calixto García','Cueto','Frank País','Gibara','Holguín','Mayarí','Moa','Rafael Freyre','Sagua de Tánamo','Urbano Noris'],
      'Granma':['Bartolomé Masó','Bayamo','Buey Arriba','Campechuela','Cauto Cristo','Guisa','Jiguaní','Manzanillo','Media Luna','Niquero','Pilón','Río Cauto','Yara'],
      'Santiago de Cuba':['Contramaestre','Guamá','Mella','Palma Soriano','San Luis','Santiago de Cuba','Segundo Frente','Songo–La Maya','Tercer Frente'],
      'Guantánamo':['Baracoa','Caimanera','El Salvador','Guantánamo','Imías','Maisí','Manuel Tames','Niceto Pérez','San Antonio del Sur','Yateras'],
      'Isla de la Juventud':['Nueva Gerona']
    },

    // Datos iniciales
    destinatarios: [],
    remitentes: [],
    searchImmediate: '',
    searchQuery: '',
    _searchTimer: null,
    lastSync: 'ahora',

    // Selección
    selectedRecipient: null,
    selectedSender: null,
    provincia: '', municipio: '', municipios: [],

    // Formularios de modales
    destinatario: {
      primer_nombre:'', segundo_nombre:'', primer_apellido:'', segundo_apellido:'',
      ci:'', telefono:'', telefono_adicional:'', calle:'', numero:'',
      entre_calle:'', y_calle:'', apto_reparto:'', piso:'', email:'', observaciones:''
    },
    remitente: { nombre_apellido:'', id_documento:'', telefono:'', direccion:'' },

    // Items
    items: [
      { id: 1, hbl:'', tipo:'air', descripcion:'', cantidad:1, peso:0, valor_aduanal:0, precio_por_kg:0, total:0 }
    ],

    // Estados
    showRecipientModal:false,
    showSenderModal:false,
    isProcessing:false,
    paymentMethod:'card',

    // Toasts
    toasts: [],

    /* ====== Init ====== */
    init(){
      // Carga datos iniciales
      let datos = {};
      try{
        datos = JSON.parse(document.getElementById('datos-iniciales').textContent || '{}');
      }catch(e){ datos = {}; }
      this.destinatarios = Array.isArray(datos.destinatarios)? datos.destinatarios : [];
      this.remitentes    = Array.isArray(datos.remitentes)? datos.remitentes : [];

      // Reloj de "última actualización"
      this.tickLastSync();

      // Hotkeys
      window.addEventListener('keydown', (e)=>{
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); this.focusSearch(); }
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='enter'){ e.preventDefault(); if(this.currentStep===3 && this.canAdvance()) this.finalizarReserva(); }
      });

      // Observadores
      this.$watch('searchQuery', () => this._icons());
      this.$watch('selectedRecipient', () => { this.persistSelection(); this._icons(); });
      this.$watch('selectedSender', () => { this.persistSelection(); this._icons(); });

      // Restaurar última selección
      this.restoreSelection();

      this.$nextTick(()=> this._icons());
    },

    /* ====== Progreso & pasos ====== */
    get progress(){
      // 3 checks: contactos ok, items ok, revisión lista
      let pct = 0;
      if(this.validContactos()) pct += 34;
      if(this.validItems())     pct += 33;
      if(this.currentStep===3)  pct += 33;
      return Math.min(100, pct);
    },
    isStepCompleted(id){
      if(id===1) return this.validContactos();
      if(id===2) return this.validItems();
      if(id===3) return false; // se completa al finalizar
      return false;
    },
    isStepAccessible(id){
      if(id===1) return true;
      if(id===2) return this.validContactos();
      if(id===3) return this.validContactos() && this.validItems();
      return false;
    },
    goToStep(id){ if(this.isStepAccessible(id)) { this.currentStep = id; this.$nextTick(()=>this._icons()); } },
    previousStep(){ if(this.currentStep>1) { this.currentStep--; this.$nextTick(()=>this._icons()); } },
    nextStep(){
      if(this.currentStep===3){ this.finalizarReserva(); return; }
      if(this.currentStep<3 && this.canAdvance()){ this.currentStep++; this.$nextTick(()=>this._icons()); }
    },
    canAdvance(){
      if(this.currentStep===1) return this.validContactos();
      if(this.currentStep===2) return this.validItems();
      return true;
    },
    canAdvanceToReview(){ return this.validContactos() && this.validItems(); },

    /* ====== Búsqueda ====== */
    onSearchInput(ev){
      clearTimeout(this._searchTimer);
      const val = ev?.target?.value || '';
      this._searchTimer = setTimeout(()=>{ this.searchQuery = val; }, 160);
    },
    focusSearch(){ const el = document.querySelector('input[placeholder*="Buscar"]'); if(el) el.focus(); },
    clearSearch(){ this.searchImmediate=''; this.searchQuery=''; },

    _norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); },
    filteredDestinatarios(){
      const q = this._norm(this.searchQuery);
      if(!q) return this.destinatarios;
      return this.destinatarios.filter(d =>
        this._norm(d.nombre_completo).includes(q) ||
        this._norm(d.telefono).includes(q) ||
        this._norm(d.direccion_completa).includes(q)
      );
    },
    filteredRemitentes(){
      const q = this._norm(this.searchQuery);
      if(!q) return this.remitentes;
      return this.remitentes.filter(r =>
        this._norm(r.nombre_apellido).includes(q) ||
        this._norm(r.telefono).includes(q) ||
        this._norm(r.direccion||'').includes(q)
      );
    },

    /* ====== Contactos ====== */
    updateMunicipios(){ this.municipios = this.provinciasDisponibles[this.provincia] || []; this.municipio=''; },

    selectRecipient(d){ this.selectedRecipient = d; this.toast('ok','Destinatario seleccionado','Se ha establecido el destinatario.'); },
    selectSender(r){ this.selectedSender = r; this.toast('ok','Remitente seleccionado','Se ha establecido el remitente.'); },

    resetDestinatario(){
      this.destinatario = { primer_nombre:'', segundo_nombre:'', primer_apellido:'', segundo_apellido:'', ci:'', telefono:'', telefono_adicional:'', calle:'', numero:'', entre_calle:'', y_calle:'', apto_reparto:'', piso:'', email:'', observaciones:'' };
      this.provincia=''; this.municipio=''; this.municipios=[];
    },
    resetRemitente(){ this.remitente = { nombre_apellido:'', id_documento:'', telefono:'', direccion:'' }; },

    buildDestinatarioPayload(){ return { ...this.destinatario, provincia:this.provincia, municipio:this.municipio }; },

    async guardarDestinatario(){
      try{
        const payload = this.buildDestinatarioPayload();
        const resp = await fetch("{% url 'booking:crear_destinatario' %}",{
          method:'POST',
          headers:{ 'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: JSON.stringify(payload)
        });
        const result = await resp.json();
        if(result.success){
          this.destinatarios.unshift(result.destinatario);
          this.selectedRecipient = result.destinatario;
          this.showRecipientModal = false;
          this.toast('ok','Guardado','Destinatario creado correctamente.');
        }else{
          this.toast('warn','Validación','No se pudo crear el destinatario.'); alert(result.error || 'Error');
        }
      }catch(e){ this.toast('err','Error','No se pudo guardar el destinatario.'); }
    },

    async guardarRemitente(){
      try{
        const resp = await fetch("{% url 'booking:crear_remitente' %}",{
          method:'POST',
          headers:{ 'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: JSON.stringify(this.remitente)
        });
        const result = await resp.json();
        if(result.success){
          this.remitentes.unshift(result.remitente);
          this.selectedSender = result.remitente;
          this.showSenderModal = false;
          this.resetRemitente();
          this.toast('ok','Guardado','Remitente creado correctamente.');
        }else{
          this.toast('warn','Validación','No se pudo crear el remitente.'); alert(result.error || 'Error');
        }
      }catch(e){ this.toast('err','Error','No se pudo guardar el remitente.'); }
    },

    /* ====== Items ====== */
    addItem(){
      this.items.push({ id:Date.now(), hbl:'', tipo:'air', descripcion:'', cantidad:1, peso:0, valor_aduanal:0, precio_por_kg:0, total:0 });
      this.$nextTick(()=>this._icons());
    },
    removeItem(id){ this.items = this.items.filter(i=>i.id!==id); this.$nextTick(()=>this._icons()); },
    updateItemTotal(item){
      const peso = parseFloat(item.peso)||0;
      const precioKg = parseFloat(item.precio_por_kg)||0;
      const valorAdu = parseFloat(item.valor_aduanal)||0;
      const manejo = (item.tipo==='maritime') ? (parseFloat(item.envio_manejo ?? 10) || 0) : 0;
      item.total = (peso*precioKg) + valorAdu + manejo;
    },
    get totalWeight(){ return this.items.reduce((a,i)=> a + (parseFloat(i.peso)||0), 0); },
    get totalValue(){  return this.items.reduce((a,i)=> a + (parseFloat(i.total)||0), 0); },
    get airItems(){ return this.items.filter(i=>i.tipo==='air').length; },
    get maritimeItems(){ return this.items.filter(i=>i.tipo==='maritime').length; },

    validarArticulos(){
      for(const [idx, it] of this.items.entries()){
        if(!String(it.descripcion||'').trim()){ this.toast('warn','Artículo incompleto',`Falta descripción en el #${idx+1}`); return false; }
        if((parseInt(it.cantidad)||0) <= 0){ this.toast('warn','Cantidad inválida',`Artículo #${idx+1}`); return false; }
        if((parseFloat(it.peso)||0)   < 0){  this.toast('warn','Peso inválido',`Artículo #${idx+1}`); return false; }
        if((parseFloat(it.precio_por_kg)||0) < 0){ this.toast('warn','Precio/kg inválido',`Artículo #${idx+1}`); return false; }
        if((parseFloat(it.valor_aduanal)||0) < 0){ this.toast('warn','Valor aduanal inválido',`Artículo #${idx+1}`); return false; }
      }
      return true;
    },

    /* ====== Validaciones por paso ====== */
    validContactos(){ return !!(this.selectedSender?.id && this.selectedRecipient?.id); },
    validItems(){ return this.items.length>0 && this.validarArticulos(); },

    /* ====== Envío ====== */
    async finalizarReserva(){
      if(!this.validContactos()){ this.toast('warn','Faltan contactos','Selecciona remitente y destinatario.'); this.goToStep(1); return; }
      if(!this.validItems()){ this.toast('warn','Revisa artículos','Hay datos pendientes o inválidos.'); this.goToStep(2); return; }

      try{
        this.isProcessing = true;
        const resp = await fetch(URL_CREAR_RESERVA_ENVIO,{
          method:'POST',
          headers:{ 'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: JSON.stringify({
            remitente_id: this.selectedSender.id,
            destinatario_id: this.selectedRecipient.id,
            items: this.items
          })
        });

        const ctype = resp.headers.get('content-type') || '';
        if(ctype.includes('application/json')){
          const result = await resp.json();
          if(result?.success){
            this.toast('ok','Reserva creada','Redirigiendo a tu panel…');
            window.location.href = "{% url 'booking:user_dashboard' %}";
            return;
          }
          this.toast('err','Error','No se pudo guardar la reserva.');
        }else{
          const text = await resp.text();
          console.error('Respuesta no JSON', text);
          this.toast('err','Error','El servidor no devolvió JSON válido.');
        }
      }catch(e){
        console.error(e);
        this.toast('err','Error de red','Inténtalo nuevamente.');
      }finally{
        this.isProcessing = false;
      }
    },

    /* ====== Persistencia ligera ====== */
    persistSelection(){
      try{
        localStorage.setItem('envio:last', JSON.stringify({
          senderId:this.selectedSender?.id || null,
          recipientId:this.selectedRecipient?.id || null
        }));
      }catch(e){}
    },
    restoreSelection(){
      try{
        const raw = localStorage.getItem('envio:last'); if(!raw) return;
        const {senderId, recipientId} = JSON.parse(raw);
        if(senderId) this.selectedSender = this.remitentes.find(r=>r.id===senderId) || null;
        if(recipientId) this.selectedRecipient = this.destinatarios.find(d=>d.id===recipientId) || null;
      }catch(e){}
    },

    /* ====== Utilidades UI ====== */
    tickLastSync(){
      const upd = () => {
        this.lastSync = 'actualizado ' + new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
        setTimeout(upd, 60_000);
      };
      upd();
    },
    toast(type='ok', title='Hecho', msg=''){
      const id = Math.random().toString(36).slice(2,8);
      this.toasts.push({id,type,title,msg});
      this.$nextTick(()=>this._icons());
      setTimeout(()=>{ this.toasts = this.toasts.filter(t=>t.id!==id); }, 3800);
    },
    _icons(){ if(window.lucide) window.lucide.createIcons(); }
  }
}
</script>
{% endblock %}
