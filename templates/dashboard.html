{% extends 'base.html' %}
{% load static %}
{% block title %}Panel de Control - TravelSYS{% endblock %}

{% block content %}

<div class="min-h-screen py-6 bg-gray-50 dark:bg-gray-900">

  <div class="mx-auto max-w-[1800px] px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <header class="mb-8">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-gray-900 dark:text-white">
            Panel de Control
          </h1>
          <p class="text-sm text-gray-600 dark:text-gray-300">TravelSYS – Resumen administrativo</p>
        </div>

        <!-- Selector de rango -->
        <div x-data="{ open:false }" class="relative">
          <button
            type="button"
            @click="open=!open"
            class="inline-flex items-center gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            aria-haspopup="true"
            :aria-expanded="open"
          >
            <i class="far fa-calendar-alt"></i>
            <span>{{ selected_range|default:"Este mes" }}</span>
            <i class="fas fa-chevron-down text-xs"></i>
          </button>

          <div
            x-cloak
            x-show="open"
            @click.outside="open=false"
            x-transition
            class="absolute right-0 mt-2 w-56 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-xl z-20"
            role="menu"
          >
            <ul class="py-1 text-sm text-gray-700 dark:text-gray-200">
              <li><a class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg" href="?range=hoy">Hoy</a></li>
              <li><a class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg" href="?range=7_dias">Últimos 7 días</a></li>
              <li><a class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg" href="?range=30_dias">Últimos 30 días</a></li>
              <li><a class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg" href="?range=mes">Este mes</a></li>
              <li><a class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg" href="?range=ano">Este año</a></li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <!-- KPIs -->
    <section class="mb-10">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
        <!-- KPI -->
        <a href="{% url 'backoffice:listar_reservas' %}" class="group rounded-2xl p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300">
              <i class="fas fa-clipboard-list"></i>
            </span>
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Total reservas</p>
              <p class="mt-1 text-2xl font-extrabold text-gray-900 dark:text-white">{{ total_reservas }}</p>
            </div>
          </div>
        </a>

        <div class="group rounded-2xl p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-300">
              <i class="fas fa-dollar-sign"></i>
            </span>
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Ingresos</p>
              <p class="mt-1 text-2xl font-extrabold text-gray-900 dark:text-white">${{ ingresos_totales|floatformat:2 }}</p>
            </div>
          </div>
        </div>

        <div class="group rounded-2xl p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-rose-50 text-rose-600 dark:bg-rose-900/30 dark:text-rose-300">
              <i class="fas fa-chart-line"></i>
            </span>
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Gastos</p>
              <p class="mt-1 text-2xl font-extrabold text-gray-900 dark:text-white">${{ gastos_totales|floatformat:2 }}</p>
            </div>
          </div>
        </div>

        <div class="group rounded-2xl p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-300">
              <i class="fas fa-coins"></i>
            </span>
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Ganancia total</p>
              <p class="mt-1 text-2xl font-extrabold text-gray-900 dark:text-white">${{ ganancia_total|floatformat:2 }}</p>
            </div>
          </div>
        </div>

        <div class="group rounded-2xl p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-violet-50 text-violet-600 dark:bg-violet-900/30 dark:text-violet-300">
              <i class="fas fa-user-check"></i>
            </span>
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Usuarios activos</p>
              <p class="mt-1 text-2xl font-extrabold text-gray-900 dark:text-white">{{ usuarios_activos }}</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Acciones rápidas -->
    <section class="mb-12">
      <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4">Acciones rápidas</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4">
        <a href="{% url 'backoffice:crear_hotel' %}" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-cyan-50 text-cyan-600 dark:bg-cyan-900/30 dark:text-cyan-300"><i class="fas fa-hotel"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Nuevo hotel</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Agregar hotel</p>
            </div>
          </div>
        </a>

        <a href="{% url 'crear_usuario' %}" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300"><i class="fas fa-user-plus"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Nuevo usuario</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Registrar usuario</p>
            </div>
          </div>
        </a>

        <a href="#" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-300"><i class="fas fa-file-invoice-dollar"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Generar reporte</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Ver informes</p>
            </div>
          </div>
        </a>

        <a href="#" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-300"><i class="fas fa-cogs"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Configuración</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Parámetros del sistema</p>
            </div>
          </div>
        </a>
      </div>
    </section>

    <!-- Panel financiero -->
    <section class="mb-12">
      <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4">Panel financiero</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4">
        <a href="{% url 'backoffice:listar_tasas_cambio' %}" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-300"><i class="fas fa-exchange-alt"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Tasas de cambio</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Gestión de divisas</p>
            </div>
          </div>
        </a>

        <a href="{% url 'backoffice:listar_certificados' %}" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-pink-50 text-pink-600 dark:bg-pink-900/30 dark:text-pink-300"><i class="fas fa-certificate"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Certificados</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Reservas prepago</p>
            </div>
          </div>
        </a>

        <a href="{% url 'backoffice:listar_proveedores' %}" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-300"><i class="fas fa-truck"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Proveedores</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Control de gastos</p>
            </div>
          </div>
        </a>

        <a href="{% url 'backoffice:listar_clientes' %}" class="group rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-300"><i class="fas fa-users"></i></span>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white">Clientes</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Cuentas y créditos</p>
            </div>
          </div>
        </a>
      </div>
    </section>

    <!-- Métricas (Charts) -->
    <section class="mb-12">
      <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4">Métricas de desempeño</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-6">
          <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2">
            <i class="fas fa-chart-line text-blue-500"></i> Reservas mensuales
          </h3>
          <canvas id="reservasMensualesChart" height="140"></canvas>
        </div>
        <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-6">
          <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2">
            <i class="fas fa-chart-bar text-emerald-500"></i> Ingresos & Gastos
          </h3>
          <canvas id="ingresosGastosChart" height="140"></canvas>
        </div>
      </div>
    </section>

    <!-- Tablas: Top -->
    <section class="mb-12">
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <!-- Top agencias -->
        <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-6">
          <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2">
            <i class="fas fa-building text-indigo-500"></i> Top 5 Agencias
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
              <thead class="bg-gray-50 dark:bg-gray-900/40 text-gray-700 dark:text-gray-200 sticky top-0">
                <tr>
                  <th class="py-2">Agencia</th>
                  <th>Reservas</th>
                  <th>Ingresos</th>
                  <th>% Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for agencia in top_agencias %}
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40">
                    <td class="py-2">{{ agencia.agencia }}</td>
                    <td>{{ agencia.total_reservas }}</td>
                    <td>${{ agencia.ingresos|default:"0.00"|floatformat:2 }}</td>
                    <td>
                      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded h-2">
                        <div class="h-2 bg-blue-600 rounded" style="width: {{ agencia.porcentaje|default:'0' }}%"></div>
                      </div>
                      <span class="text-xs text-gray-500 dark:text-gray-400">{{ agencia.porcentaje|default:"0"|floatformat:1 }}%</span>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="py-4 text-gray-400">No hay datos disponibles.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Top hoteles -->
        <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-6">
          <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2">
            <i class="fas fa-hotel text-purple-500"></i> Top 5 Hoteles
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
              <thead class="bg-gray-50 dark:bg-gray-900/40 text-gray-700 dark:text-gray-200 sticky top-0">
                <tr>
                  <th class="py-2">Hotel</th>
                  <th>Reservas</th>
                  <th>Calificación</th>
                  <th>Ocupación</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for hotel in top_hoteles %}
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40">
                    <td class="py-2">{{ hotel.hotel_nombre }}</td>
                    <td>{{ hotel.num_reservas }}</td>
                    <td>
                      <div class="inline-flex justify-center">
                        {% for i in "12345"|make_list %}
                          {% if forloop.counter <= hotel.calificacion_promedio %}
                            <i class="fas fa-star text-yellow-400"></i>
                          {% else %}
                            <i class="far fa-star text-yellow-400"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                    </td>
                    <td>
                      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded h-2">
                        <div class="h-2 bg-emerald-500 rounded" style="width: {{ hotel.ocupacion }}%"></div>
                      </div>
                      <span class="text-xs text-gray-500 dark:text-gray-400">{{ hotel.ocupacion }}%</span>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="py-4 text-gray-400">No hay datos disponibles.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- Alertas -->
    <section class="mb-12">
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <!-- Pago -->
        <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-6">
          <h3 class="font-semibold text-rose-600 dark:text-rose-400 mb-4 flex items-center gap-2">
            <i class="fas fa-exclamation-circle"></i> Alerta de pago ({{ total_alerta_pago }})
          </h3>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
              <thead class="bg-gray-50 dark:bg-gray-900/40 text-gray-700 dark:text-gray-200">
                <tr>
                  <th class="py-2">Hotel</th>
                  <th>Cliente</th>
                  <th>Check-in</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for reserva in reservas_alerta_pago %}
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40">
                    <td class="py-2">
                      {% if reserva.hotel %}
                        {{ reserva.hotel.hotel_nombre }}
                      {% elif reserva.hotel_importado %}
                        {{ reserva.hotel_importado.hotel_name }}
                      {% else %}
                        <span class="text-gray-400 italic">Sin hotel</span>
                      {% endif %}
                    </td>
                    <td>{{ reserva.nombre_usuario }}</td>
                    <td>{{ reserva.habitaciones_reserva.first.fechas_viaje|slice:":10" }}</td>
                    <td>
                      <span class="inline-flex px-2 py-0.5 rounded-full text-xs border
                                   {% if reserva.estatus == 'PENDIENTE' %}
                                     bg-amber-50 text-amber-700 border-amber-200
                                   {% elif reserva.estatus == 'PAGADA' %}
                                     bg-emerald-50 text-emerald-700 border-emerald-200
                                   {% else %}
                                     bg-gray-50 text-gray-700 border-gray-200
                                   {% endif %}">
                        {{ reserva.estatus }}
                      </span>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="py-4 text-gray-400">Sin registros.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <div class="flex justify-center mt-4">
            <nav class="inline-flex rounded-lg border bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm overflow-hidden">
              {% if reservas_alerta_pago.has_previous %}
                <a href="?pago_page=1" class="px-3 py-1 border-r dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&laquo;&laquo;</a>
                <a href="?pago_page={{ reservas_alerta_pago.previous_page_number }}" class="px-3 py-1 border-r dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&laquo;</a>
              {% endif %}
              <span class="px-3 py-1 font-bold bg-indigo-600 text-white">{{ reservas_alerta_pago.number }}</span>
              {% if reservas_alerta_pago.has_next %}
                <a href="?pago_page={{ reservas_alerta_pago.next_page_number }}" class="px-3 py-1 border-l dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&raquo;</a>
                <a href="?pago_page={{ reservas_alerta_pago.paginator.num_pages }}" class="px-3 py-1 border-l dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&raquo;&raquo;</a>
              {% endif %}
            </nav>
          </div>
        </div>

        <!-- Cobro -->
        <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-6">
          <h3 class="font-semibold text-amber-600 dark:text-amber-400 mb-4 flex items-center gap-2">
            <i class="fas fa-exclamation-triangle"></i> Alerta de cobro ({{ total_alerta_cobro }})
          </h3>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
              <thead class="bg-gray-50 dark:bg-gray-900/40 text-gray-700 dark:text-gray-200">
                <tr>
                  <th class="py-2">Hotel</th>
                  <th>Cliente</th>
                  <th>Check-in</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for reserva in reservas_alerta_cobro %}
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40">
                    <td class="py-2">
                      {% if reserva.hotel %}
                        {{ reserva.hotel.hotel_nombre }}
                      {% elif reserva.hotel_importado %}
                        {{ reserva.hotel_importado.hotel_name }}
                      {% else %}
                        <span class="text-gray-400 italic">Sin hotel</span>
                      {% endif %}
                    </td>
                    <td>{{ reserva.nombre_usuario }}</td>
                    <td>{{ reserva.habitaciones_reserva.first.fechas_viaje|slice:":10" }}</td>
                    <td>
                      <span class="inline-flex px-2 py-0.5 rounded-full text-xs border
                                   {% if reserva.estatus == 'PENDIENTE' %}
                                     bg-amber-50 text-amber-700 border-amber-200
                                   {% elif reserva.estatus == 'COBRADA' %}
                                     bg-emerald-50 text-emerald-700 border-emerald-200
                                   {% else %}
                                     bg-gray-50 text-gray-700 border-gray-200
                                   {% endif %}">
                        {{ reserva.estatus }}
                      </span>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="py-4 text-gray-400">Sin registros.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <div class="flex justify-center mt-4">
            <nav class="inline-flex rounded-lg border bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm overflow-hidden">
              {% if reservas_alerta_cobro.has_previous %}
                <a href="?cobro_page=1" class="px-3 py-1 border-r dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&laquo;&laquo;</a>
                <a href="?cobro_page={{ reservas_alerta_cobro.previous_page_number }}" class="px-3 py-1 border-r dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&laquo;</a>
              {% endif %}
              <span class="px-3 py-1 font-bold bg-indigo-600 text-white">{{ reservas_alerta_cobro.number }}</span>
              {% if reservas_alerta_cobro.has_next %}
                <a href="?cobro_page={{ reservas_alerta_cobro.next_page_number }}" class="px-3 py-1 border-l dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&raquo;</a>
                <a href="?cobro_page={{ reservas_alerta_cobro.paginator.num_pages }}" class="px-3 py-1 border-l dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">&raquo;&raquo;</a>
              {% endif %}
            </nav>
          </div>
        </div>
      </div>
    </section>

    <!-- Nuevos usuarios -->
    <section class="mb-6">
      <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4">Nuevos usuarios registrados</h2>
      <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-6 overflow-x-auto">
        <table class="min-w-full text-sm text-center">
          <thead class="bg-gray-50 dark:bg-gray-900/40 text-gray-700 dark:text-gray-200">
            <tr>
              <th class="py-2">Nombre</th>
              <th>Email</th>
              <th>Fecha registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
            {% for usuario in ultimos_usuarios %}
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/40">
                <td class="py-2">{{ usuario.agencia }}</td>
                <td>{{ usuario.email }}</td>
                <td>{{ usuario.date_joined|date:"d/m/Y H:i" }}</td>
                <td class="space-x-1">
                  <a href="{% url 'editar_usuario' usuario_id=usuario.id %}"
                     class="inline-flex items-center px-2 py-1 rounded border border-gray-300 dark:border-gray-600 text-blue-600 hover:bg-blue-50 dark:hover:bg-gray-700"
                     title="Editar"><i class="fas fa-user-edit"></i></a>
                  <button type="button"
                     class="inline-flex items-center px-2 py-1 rounded border border-gray-300 dark:border-gray-600 text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"
                     title="Enviar mensaje" disabled><i class="fas fa-envelope"></i></button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="py-4 text-gray-400">No hay nuevos usuarios registrados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- Charts -->
  {{ labels_meses|json_script:"labels-data" }}
  {{ datos_reservas_mensuales|json_script:"reservas-data" }}
  {{ datos_ingresos|json_script:"ingresos-data" }}
  {{ datos_gastos|json_script:"gastos-data" }}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // Data
      const labels   = JSON.parse(document.getElementById('labels-data').textContent || '[]');
      const reservas = JSON.parse(document.getElementById('reservas-data').textContent || '[]');
      const ingresos = JSON.parse(document.getElementById('ingresos-data').textContent || '[]');
      const gastos   = JSON.parse(document.getElementById('gastos-data').textContent || '[]');

      // Theme-aware grid color
      const isDark = document.documentElement.classList.contains('dark');
      const gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)';
      const ticksColor = isDark ? '#e5e7eb' : '#374151';

      // Reservas line
      new Chart(document.getElementById('reservasMensualesChart').getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Reservas',
            data: reservas,
            backgroundColor: 'rgba(59,130,246,0.1)',
            borderColor: 'rgba(59,130,246,1)',
            fill: true,
            tension: prefersReduced ? 0 : 0.35,
            pointRadius: 3,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          animation: prefersReduced ? false : { duration: 600 },
          plugins: { legend: { display:false }, tooltip: { callbacks: { label: c => `Reservas: ${c.parsed.y}` } } },
          scales: {
            x: { grid: { color: gridColor }, ticks: { color: ticksColor } },
            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: ticksColor } }
          }
        }
      });

      // Ingresos vs Gastos
      new Chart(document.getElementById('ingresosGastosChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Ingresos', data: ingresos, backgroundColor: 'rgba(16,185,129,0.7)', borderColor: 'rgba(5,150,105,1)', borderWidth: 1 },
            { label: 'Gastos',   data: gastos,   backgroundColor: 'rgba(239,68,68,0.7)',  borderColor: 'rgba(220,38,38,1)',  borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          animation: prefersReduced ? false : { duration: 600 },
          plugins: {
            legend: { position: 'bottom', labels: { color: ticksColor } },
            tooltip: { callbacks: { label: c => `${c.dataset.label}: $${(c.parsed.y||0).toLocaleString()}` } }
          },
          scales: {
            x: { grid: { color: gridColor }, ticks: { color: ticksColor } },
            y: {
              beginAtZero: true,
              grid: { color: gridColor },
              ticks: { color: ticksColor, callback: v => `$${v.toLocaleString()}` }
            }
          }
        }
      });
    });
  </script>

  <!-- Micro-estilos no intrusivos -->
  <style>
    [x-cloak]{display:none!important}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:9999px}
    .dark ::-webkit-scrollbar-thumb{background:#475569}
  </style>
</div>

{% endblock %}